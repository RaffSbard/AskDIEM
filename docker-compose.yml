services:
  # --- SERVIZIO 1: IL DATABASE VETTORIALE LOCALE ---
  qdrant_db:
    image: qdrant/qdrant:latest  # Usa l'immagine ufficiale di Qdrant
    container_name: askdiem_qdrant_db
    ports:
      - "6333:6333" # Porta API
      - "6334:6334" # Porta gRPC
    volumes:
      # Questo Ã¨ il "volume esterno" che salva i dati del vector store
      - qdrant_storage:/qdrant/storage
      # Volume per i snapshot di backup/restauro
      - ./qdrant_snapshots:/qdrant/snapshots

  # --- SERVIZIO 2: L'APPLICAZIONE (STREAMLIT + UPDATER) ---
  askdiem_app:
    # Costruisce l'immagine usando il Dockerfile nella stessa cartella
    build:
      context: .
      dockerfile: Dockerfile
    container_name: askdiem_app
    ports:
      - "8501:8501" # Esponi la porta di Streamlit
    volumes:
      # Volumi esterni per i file di stato del crawler
      - ./data:/app/data
      - ./urls_lists:/app/urls_lists
      - ./nodes:/app/nodes
      - ./qdrant_snapshots:/app/snapshots
    environment:
      # Passa le chiavi API dall'esterno (devono essere in un file .env)
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - COHERE_API_KEY=${COHERE_API_KEY}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      # Dice all'app Python dove trovare il container di Qdrant
      - QDRANT_URL=http://qdrant_db:6333
    depends_on:
      - qdrant_db # Assicura che Qdrant parta prima dell'app

# Definizione del volume persistente per Qdrant
volumes:
  qdrant_storage: